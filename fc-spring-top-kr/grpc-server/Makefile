# ============================================
# ğŸ§  Spring Boot gRPC Server Makefile
# ============================================

# --- Configuration Variables ---
APP_NAME := grpc-server
JAR_FILE := target/$(APP_NAME)-0.0.1-SNAPSHOT.jar
GRPC_PORT := 9090
HTTP_PORT := 8080

# Maven Wrapper (use ./mvnw if available)
MVN := ./mvnw

# --- Commands ---

## ğŸ§¹ Clean all build artifacts
clean:
	@echo "ğŸ§¹ Cleaning project..."
	$(MVN) clean

## ğŸ§± Compile Java & Protobuf files
compile:
	@echo "ğŸ§± Compiling sources and generating protobuf classes..."
	$(MVN) clean compile

## ğŸ§ª Run tests
test:
	@echo "ğŸ§ª Running tests..."
	$(MVN) test

## ğŸš€ Run Spring Boot gRPC server locally
run:
	@echo "ğŸš€ Starting gRPC server on port $(GRPC_PORT) (HTTP on $(HTTP_PORT))..."
	$(MVN) spring-boot:run

## ğŸ§© Regenerate protobuf classes manually (if needed)
proto:
	@echo "ğŸ”§ Regenerating protobuf Java classes..."
	$(MVN) protobuf:compile
	$(MVN) protobuf:compile-custom

## ğŸ“¦ Package project into JAR
package:
	@echo "ğŸ“¦ Packaging application..."
	$(MVN) clean package -DskipTests

## ğŸ§° Run packaged JAR
start:
	@echo "ğŸš€ Running $(APP_NAME) JAR..."
	java -jar $(JAR_FILE)

## ğŸ§± Build Docker image
docker-build:
	@echo "ğŸ³ Building Docker image..."
	docker build -t $(APP_NAME):latest .

## ğŸƒ Run Docker container
docker-run:
	@echo "ğŸ³ Running Docker container..."
	docker run -p $(HTTP_PORT):8080 -p $(GRPC_PORT):9090 $(APP_NAME):latest

## ğŸ§½ Stop all Docker containers for this app
docker-stop:
	@echo "ğŸ›‘ Stopping running containers..."
	docker ps -q --filter "ancestor=$(APP_NAME):latest" | xargs -r docker stop

## ğŸ§¾ Show logs of the running Spring Boot app
logs:
	@echo "ğŸ“œ Showing Spring Boot logs..."
	tail -f logs/spring.log

## ğŸ’¡ Help command
help:
	@echo ""
	@echo "ğŸ“˜ Available Makefile Commands for gRPC Server:"
	@echo "------------------------------------------------"
	@echo " make clean           - Clean project build files"
	@echo " make compile         - Compile Java and generate gRPC stubs"
	@echo " make test            - Run all tests"
	@echo " make run             - Run Spring Boot gRPC app (dev mode)"
	@echo " make proto           - Rebuild protobuf-generated classes"
	@echo " make package         - Build JAR without running tests"
	@echo " make start           - Run JAR directly"
	@echo " make docker-build    - Build Docker image"
	@echo " make docker-run      - Run app in Docker container"
	@echo " make docker-stop     - Stop Docker container"
	@echo " make logs            - Tail application logs"
	@echo " make help            - Show this help message"
	@echo ""
